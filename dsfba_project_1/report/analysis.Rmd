# Analysis {.tabset}

```{r, echo = FALSE, message = FALSE, warning = FALSE}
source(here::here("scripts/setup.R"))
```

### 4.1 Crime VS CCTVs - Does the presence of CCTV deter crime?

The idea here is to see whether there is any relationship between crime per capita and CCTV density. To do so, we first create a simple linear regression model. We create a new data frame called `CCTV_VS_crimes` (which basically is a left joint). The linear regression indicates a rather weak correlation between higher crime per capita and higher CCTV density. The $R^2$ is at 35%. Still, plotting the observations enables one to see a tendency. The blue line represent the regression line.

```{r echo=FALSE, results = 'markup'}

CCTV_VS_crimes <- CCTV_per_area %>% 
  left_join(CrimeStatsPerArea,by="Community")
  
regression <- lm(CCTV_VS_crimes$density_perc~CCTV_VS_crimes$CrimePer1000inhabitants)
summary(regression)

stargazer(regression,
          type = "text")

ggplot(data=CCTV_VS_crimes,mapping= aes(x=CrimePer1000inhabitants,y=density_perc)) + 
  labs(title = "Crime per Capita per Community VS CCTV Density per Community", x="CrimePerCapitaPerCommunity",y="CCTVDensityPerCommunity")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```

#### 4.1.1 Mapping of CCTVs and crime, felony and misdemeanor per capita

In these section we engage with the mapping of the CCTVs and crimes. The method is the same as before with the `tmap` package. However, this time we have two different shapes: `tm_shape(baltimore)` which constitutes the base map and `tm_shape(balt_dat)` which adds a layer containing points. If we take a look at this map we see that it gives an intuition about the phenomenon we illustrated before. It seems as if where crime per capita is the lowest, there seems to be less CCTVs (for instance in the north area of the city or even in the western areas). There seems to be a correlation between the dark red areas and the CCTV per area.   

```{r results='markup'}

Crime_and_CCTV_map <- tm_shape(baltimore) + tm_fill(col = "CrimePer1000inhabitants", title ="Crime per capita per Area in %",style = "quantile") + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.05)+ tm_shape(balt_dat) + tm_dots(col="black")

Felony_and_CCTV_map <- tm_shape(baltimore) + tm_fill(col = "FelonyPerCapitaPerArea", title ="Felony per capita per Area in %", style = "quantile") + tm_borders(col="black",alpha=0.3)+ tm_layout(inner.margins = 0.05) + tm_shape(balt_dat) + tm_dots(col="black")

Misdemeanor_and_CCTV_map <- tm_shape(baltimore) + tm_fill(col = "MisdemeanorPerCapitaPerArea", title ="Misdemeanor per capita per Area in %",style = "quantile") + tm_borders(col="black",alpha=0.3)+ tm_layout(inner.margins = 0.05) + tm_shape(balt_dat) + tm_dots(col="black")

tmap_mode("view") #Use this command to have interactive maps

baltimore@data[["fid"]]<-baltimore@data[["community"]] #We do that so that we see the name of the Community when using an interactive map

tmap_arrange(Crime_and_CCTV_map,Felony_and_CCTV_map,Misdemeanor_and_CCTV_map)
```


<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

This map shows quite well that CCTV placement seems to follow the areas where crime per capita is the highest. Looking at the north-western and south-western areas of the map, it can be seen that the placement of CCTVs aligns rather well with the areas considered dangerous.

```{r}
Crime_per_capita_VS_CCTV_map <- tm_shape(baltimore) + tm_fill(col = "CrimePer1000inhabitants", title ="Crime per capita",style = "quantile") + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.05) + tm_shape(balt_dat) + tm_dots(col="black") 

tmap_mode("plot")
Crime_per_capita_VS_CCTV_map

```

We are still not sure whether we should use the automatic breaking feature of `tmap` of whether we should set personalized map breaks. The following chunk illustrates how we could create personalized break arguments.


```{r}
sort(baltimore@data[["CrimePer1000inhabitants"]])

breaks1 <- c(0,250,500,750,1000,1250,1500) #Not sure what break to use, for the moment I decided to use the automatic break system with the "quantile" parameter

tmap_mode("plot") #We go back to classic plotting
```

#### 4.1.2 Analysis of where crime took place: August 2021

We are still trying to see whether the presence of CCTV can deter crime. One thing that could be interesting is to spatially locate crime and compare it to CCTV location. We know that CCTCs capture activities within 256ft (~2 blocks). We will only select crime committed in August 2021 to have intereprtable data (choosing a larger time frame would make the map unreadable). We choose August 2021 because it is the latest full month which we have in our data set. Taking the latest time points from the data assures us that most of the CCTVs presented in the data set were already there (since we have no information of when exactly these CCTVs were added). Again, as before, we create a data table, assign coordinates, define CRS (in this case the CRS is "EPDS4326", which we needed to transform using `spTransform`). Again, we create a map with `tm_shape` to visualise the results. The output shows where crime takes place compared to the CCTV location. By zooming on the map, we see that some crimes are committed directly in front of CCTVs. Although this is not conclusive evidence, this observation goes against the idea that CCTVs are effective crime deterrents. 

```{r results='markup'}

crime_spatial <- as.data.table(crime_data_with_areas %>%  filter(CrimeDateTime >= as.Date("2021-08-01") & CrimeDateTime <= as.Date("2021-08-31")))
coordinates(crime_spatial) <-  c("Longitude","Latitude")
proj4string(crime_spatial) <-  CRS("+init=epsg:4326")
crime_spatial <- spTransform(crime_spatial,crs.geo1)

August21Crimes_VS_CCTV <- tm_shape(baltimore) + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.1, title="Crimes committed in August 2021 VS CCTV location",frame.lwd = 5)+ tm_shape(balt_dat) + tm_dots(col="black")+tm_shape(crime_spatial)+tm_dots(col="red",alpha=0.5)

#It could be interesting to see where crime took place relative to CCTV locations in the area with the highest crime rate in August 2021

tmap_mode("view") #Use this command to have interactive maps
August21Crimes_VS_CCTV
```

To further prove that point we decided to focus on one specific area. We arbitrarily decided to focus on the area which had the highest crime incidence in August. Thus, we needed to calculate the crime rate for August per area to see where crime was highest. The results show that they are in Downtown. 
So following this we take a closer look at the Downtown area.

```{r}
CrimePerCapitaPerAreaAugust2021 <- crime_data_with_areas %>%  filter(CrimeDateTime >= as.Date("2021-08-01") & CrimeDateTime <= as.Date("2021-08-31")) %>% 
  group_by(Community) %>%
  summarize(CrimeFrequency=n())

CrimePerCapitaPerAreaAugust2021 <-mutate(CrimePerCapitaPerAreaAugust2021,CrimePer1000inhabitants=((CrimePerCapitaPerAreaAugust2021$CrimeFrequency/population_data$tpop20)*1000))
#We see that Downtown is the area with the highest crime rate in August 2021, we might want to focus on that area and see whether there is crime that take place directly next to CCTVs


```


In order to create a "sub-map", we create a smaller area using the `st-bbox` function. The values indicated in the function represent the most extreme values on the x-axis and y-axis of a map using the EPSG:3857 WGS 84 / Pseudo-Mercator coordinate system. Then, using `tm_shape` with the new spatial file called `Downtown_area`as argument, we create a map in the same way as we have done before. As we want to be able to locate this smaller area in the picture map of baltimore, we must also create a Baltimore map with a rectangle representing the newly created "sub-area". In order to combine these two maps together, we run the two last lines together and use the `viewport` function. The output is a zoom on the desired area combined with the bigger map having a rectangle over the area which we are looking at and analyzing. In Downtown, we quite clearly see that some crimes are committed right next to some CCTVs.

```{r}
Downtown_area <-  st_bbox(c(xmin = -8531335.08, xmax = -8526873.06,
                      ymin =4765236.47, ymax = 4762527.65),
                    crs = st_crs(baltimore)) %>% st_as_sfc()
 
Downtown_map <- tm_shape(Downtown_area) + tm_borders(col="white")+ tm_shape(baltimore) + tm_borders(col="black") + tm_layout(inner.margins = 0.05,frame.lwd = 5,title = "Zoom on Downtown Area",title.position = c('left', 'top'))+tm_scale_bar(position = c("left", "top"))+ tm_shape(balt_dat) + tm_symbols(shape = 2, col = "black", size = 0.07)+tm_shape(crime_spatial)+tm_dots(col="red")

Baltimore_map_2 <- tm_shape(baltimore) + tm_borders()+ tm_shape(Downtown_area) + tm_borders(lwd = 1.5,col = "red") + tm_layout(frame.lwd = 6,inner.margins = 0.05)

tmap_mode("plot")
Downtown_map
print(Baltimore_map_2, vp = viewport(0.8, 0.27, width = 0.5, height = 0.5)) #By running these two lines together, we obtain the map with an additional overview
```

#### 4.1.3 Anomaly #1 : Prison

At the moment, we did not have enough time to focus on all the elements that seems to be outliers. Still, we had time to focus on Baltimore's prison, which seems to be interesting. The methodology to create this map is the same as described above. It is interesting to analyse the prison and its surrounding area, since we have many CCTVs around it (which intuitively make sense), high crime per capita around (as in most central areas) but basically no crime inside it as we have no data about it.

```{r}
tmap_mode("plot")

Prison_area <-  st_bbox(c(xmin = -8529169.92, xmax = -8526465.97,
                      ymin =4764196.55, ymax = 4765056.50),
                    crs = st_crs(baltimore)) %>% st_as_sfc()
 
Prison_map <- tm_shape(Prison_area) + tm_borders(col="black",alpha=0.3)+ tm_shape(baltimore) + tm_fill(col = "CrimePer1000inhabitants", title ="Crime per Capite per Area",style = "quantile") + tm_borders(col="black") + tm_layout(inner.margins = 0.05,frame.lwd = 5,title = "Zoom on Baltimore Prison",title.position = c('left', 'top'))+tm_scale_bar(position = c("left", "top"))+ tm_shape(balt_dat) + tm_dots(col="black") #This map zooms on the prison. This "Area" is special. We have no data on crime there, we can also see that the there is a huge concentration of CCTVs directly next to the prison.


Baltimore_map <- tm_shape(baltimore) + tm_borders()+ tm_shape(Prison_area) + tm_borders(lwd = 3,col = "red") + tm_layout(frame.lwd = 6,inner.margins = 0.05)


Prison_map
print(Baltimore_map, vp = viewport(0.8, 0.27, width = 0.5, height = 0.5)) #By running these two lines together, we obtain 
```

### 4.2 What types of crimes may be deterred by surveillance cameras?

The logic here is the same as in section 4.1, except that here,we want to see whether the presence of CCTV can deter a certain type of crime. We start with felonies and misdemeanors, then we analyse violent and property crimes.

#### 4.2.1 CCTVs VS Felonies and Misdemeanors

The results of the simple linear regression shows a weak $R^2$ for both felonies and misdemeanors and felonies. It therefore does not seem like the presence of CCTV has a particularly strong impact on a certain type of crime. 

```{r echo=FALSE, results = 'markup'}

#Felonies

CCTV_VS_Felony <- CCTV_per_area %>% 
  left_join(FelonyStats,by="Community")

regression5 <- lm(CCTV_VS_Felony$density_perc~CCTV_VS_Felony$FelonyPerCapitaPerArea)
summary(regression5)

ggplot(data=CCTV_VS_Felony,mapping= aes(x=FelonyPerCapitaPerArea,y=density_perc)) + 
  labs(title = "Felony per Capita per Community VS CCTV Density per Community", x="FelonyPerCapitaPerCommunity",y="CCTVDensityPerCommunity")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)

#Misdemeanors

CCTV_VS_misdemeanors <- CCTV_per_area %>% 
  left_join(MisdemeanorStats,by="Community")

regression6 <- lm(CCTV_VS_misdemeanors$density_perc~CCTV_VS_misdemeanors$MisdemeanorPerCapitaPerArea)
summary(regression6)

ggplot(data=CCTV_VS_misdemeanors,mapping= aes(x=MisdemeanorPerCapitaPerArea,y=density_perc)) + 
  labs(title = "Misdemeanor per Capita per Community VS CCTV Density per Community", x="MisdemeanorPerCapitaPerCommunity",y="CCTVDensityPerCommunity")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```
#### 4.2.2 CCTVs VS Violent and Property Crime

```{r echo=FALSE, results = 'markup'}

CCTV_VS_ViolentCrime <- CCTV_per_area %>% 
  left_join(ViolentStats,by="Community")

regression21 <- lm(CCTV_VS_ViolentCrime$density_perc~CCTV_VS_ViolentCrime$ViolentCrimePerCapitaPerArea)

summary(regression21)

CCTV_VS_PropertyCrime <- CCTV_per_area %>% 
  left_join(PropertyStats,by="Community")

regression22 <- lm(CCTV_VS_PropertyCrime$density_perc~CCTV_VS_PropertyCrime$PropertyCrimePerCapitaPerArea)

summary(regression22)

#We observe a stronger correlation between Violent Crime and CCTV density compared to Property crime and CCTV density

ggplot(Community_data,aes(x=ViolentCrimePerCapitaPerArea,y=density_perc))+
  geom_point()+
  geom_smooth(se=F)+
  labs(x="Violent Crime per Capita per Area",y="CCTV Density per Area",title="CCTV density increases with violent crime",subtitle = str_wrap("Yet, we observe that the lack of data about CCTV in some areas has an impact."),width=45)

ggplot(Community_data,aes(x=PropertyCrimePerCapitaPerArea,y=density_perc))+
  geom_point()+
  geom_smooth(se=F)+
  labs(x="Property Crime per Capita per Area",y="CCTV Density per Area",title="CCTV density is weakly correlated with property crime",subtitle = str_wrap("The correlation is much weaker than between CCTV density and violent crime"),width=45)

```


### 4.3 Comparison of CCTV density and wealth

We went to see whether there is a correlation between CCTV density and wealth. One of our initial hypothesis was that the government respected more the privacy of wealthier people. So, similarly, we perform a regression. The results here are not so conclusive, since we have a poor $adjusted R^2$ and a poor $R^2$. The next sub-section illustrates this in a map.

```{r echo=FALSE, results = 'markup'}

CCTV_VS_poverty <- CCTV_per_area %>% 
  left_join(poverty_data,by=c("Community"="CSA2010"))

regression2 <- lm(CCTV_VS_poverty$density_perc~CCTV_VS_poverty$hhpov19)
summary(regression2)

ggplot(data=CCTV_VS_poverty,mapping= aes(x=hhpov19,y=density_perc)) + 
  labs(title = "CCTV density VS poverty rate", x="Poverty rate",y="CCTV Density")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```

#### 4.3.1 Mapping of CCTVs and wealth

The methodology to create the map is always the same: we ensure a perfect match, then merge the data using `left_join` and finally create the map using `tmap`. While the simple linear regression was not so conclusive, it seems like the map enables one to grasp interesting patterns. If we look at the map we see that at least those areas with no CCTVs are more likely to be quite wealthy. However, we are not sure whether this is the only influential factor here, thus we think it is rather correlated to crime per capita in these areas. Again, in the northern parts we see less CCTV, less crime, and also more wealthier population.

```{r echo=FALSE, results = 'markup'}

baltimore$community %in% poverty_data$CSA2010 #We see that we have a perfect match

baltimore@data <- left_join(baltimore@data, poverty_data, by = c('community' = 'CSA2010'))

Wealth_and_CCTV_map <- tm_shape(baltimore)+tm_fill(col = "hhpov19", title ="Poverty rate per Area",style = "quantile") + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.05)+ tm_shape(balt_dat) + tm_dots(col="black") #This visualization is particularly interesting. Indeed, while the regression between crime rates and CCTV density was not very conclusive (we obtained a very poor R squared suggesting a poor correlation between poverty and CCTV density), this map might actually explain why we obtained such result and give us interesting hints. Indeed, we see that many CCTVs are located in Downtown/Seton Hill and in Inner Harbor/Federal Hill, namely in the centre of Baltimore and that the poverty rates is very low in these two regions. This makes sense as centers of city are typically not the poorest areas. Yet, what we also see is that many of the least poor region in the "suburbs" often have very low CCTV densities. This might confirm the idea that there tends to be less CCTVs in richer neighborhood.

tmap_mode("view")
Wealth_and_CCTV_map
```

### 4.4 Comparison of crimes and wealth

We want to investigate whether or not wealthier areas are more or less impacted by crime. To do so, we once more compute a simple linear regression. We again see that the $R^2$ is quite poor.

```{r echo=FALSE, results = 'markup'}

Crime_VS_Poverty <- CrimeStatsPerArea %>% 
  left_join(poverty_data,by=c("Community"="CSA2010"))

regression3 <- lm(Crime_VS_Poverty$CrimePer1000inhabitants~Crime_VS_Poverty$hhpov19)
summary(regression3)

ggplot(data=Crime_VS_Poverty,mapping= aes(x=hhpov19,y=CrimePer1000inhabitants)) + 
  labs(title = "Crime per Capita VS poverty rate", x="Poverty rate",y="Crime per Capita")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```

### 4.5 Felonies VS Misdemeanors - Do we have an equal crime type distribution?

It is always interesting to see whether we can spot patterns in crime date. The idea here is to analyse whether  we tend to observe an equal distribution of felony and misdemeanors in each area. By computing a simple linear regression, we see that the two types of crime seems rather equally distributed in each area. Still, it is interesting to observe that the biggest outline on the scatter plot is Downtown/Seton Hill. In Downtown, misdemeanor per capita is much larger than the felony per capita We don't whether this finding is relevant, yet, it must be mentioned that this area also is one of the richest area in Baltimore. This might **suggest** the idea that richer areas are more impacted by less severe crimes.

```{r echo=FALSE, results = 'markup'}

Felony_VS_Misdemeanor <- FelonyStats %>% 
  left_join(MisdemeanorStats,by="Community")

regression4 <- lm(Felony_VS_Misdemeanor$FelonyPerCapitaPerArea~Felony_VS_Misdemeanor$MisdemeanorPerCapitaPerArea)
summary(regression4)#This allows us to see whether Felony and Misdemeanors are correlated. This seems to be the case

ggplot(data=Felony_VS_Misdemeanor,mapping= aes(x=FelonyPerCapitaPerArea,y=MisdemeanorPerCapitaPerArea)) + 
  labs(title = "Misdemeanor VS Felony", x="Felons per capita",y="Misdemeanor per capita")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)

#Still, we see that there seems ot be some outliers. I don't know if it is relevant but the biggest outlier is Downtown/Seton Hill, is turns out it also is one of the richest area in Baltimore.
```

### 4.6 Attempt to create a more accurate model: Multiple Regression

```{r echo=FALSE, results = 'markup'}

#Socio-economic indicators:

Unemployment <- read.csv(file = here::here("data/Unemployment_Rate.csv"))

Unemployment[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0,0,0,0,0,0,0)

Internet_data <- read.csv(file = here::here("data/Percent_of_Households_with_No_Internet_at_Home.csv"))

Internet_data[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0)

#Educational indicators:

HSAexam <- read.csv(file = here::here("data/Percentage_of_Students_Passing_H.S.A._Government.csv"))

HSAexam[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0)

Readiness <- read.csv(file = here::here("data/Kindergarten_School_Readiness.csv"))

Readiness[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0)

#Racial indicators

Caucasian_perc <- read.csv(file = here::here("data/Percent_of_Residents_-_White_Caucasian_(Non-Hispanic).csv"))

Caucasian_perc[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0,0,0,0)

AfroAm_perc <- read.csv(file = here::here("data/Percent_of_Residents_-_Black_African-American_(Non-Hispanic).csv"))

AfroAm_perc[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0,0,0,0)

Community_data <- Community_data %>% 
  left_join(HSAexam[,c(2,6)],by=c("Community"="CSA2010")) %>%
  left_join(Internet_data[,c(2,5)],by=c("Community"="CSA2010")) %>% 
  left_join(Readiness[,c(2,5)],by=c("Community"="CSA2010")) %>% 
  left_join(Unemployment[,c(2,12)],by=c("Community"="CSA2010"))%>% 
  left_join(Caucasian_perc[,c(2,9)],by=c("Community"="CSA2010"))%>% 
  left_join(AfroAm_perc[,c(2,9)],by=c("Community"="CSA2010"))

fullmod <- lm(Community_data$density_perc~Community_data$ViolentCrimePerCapitaPerArea + Community_data$hhpov19 +Community_data$hsagov14 + Community_data$nohhint19+Community_data$ready13+Community_data$unempr19+Community_data$pwhite20+Community_data$paa20)

nullmod <- lm(Community_data$density_perc~1)

selAIC <- step(nullmod,scope=list(lower=nullmod,upper=fullmod),direction="forward")
summary(selAIC) #We have a satisfactory R-Squared

library(car)
vif(selAIC) #Yet, the issue is that we have multicollinearity

lm(Community_data$paa20~Community_data$pwhite20)
summary(lm(Community_data$paa20~Community_data$pwhite20)) #This illustrates the mutlicollinearity issue, percentage of white people is highly correlated with percentage of black people

lm(Community_data$density_perc~Community_data$pwhite20+Community_data$paa20)
summary(lm(Community_data$density_perc~Community_data$pwhite20+Community_data$paa20)) #We observe that the percentage of white people is negatively correlated with CCTV density while the percentage of black people is positively correlated. However, none of the results are significant.

lm(Community_data$density_perc~Community_data$pwhite20)
summary(lm(Community_data$density_perc~Community_data$pwhite20))

lm(Community_data$density_perc~Community_data$paa20)
summary(lm(Community_data$density_perc~Community_data$paa20)) #Overall, this enables us to conclude that the race does not seem to be such a good predictor

fullmod2 <- lm(Community_data$density_perc~Community_data$ViolentCrimePerCapitaPerArea + Community_data$hhpov19 +Community_data$hsagov14 + Community_data$nohhint19 + Community_data$ready13 + Community_data$unempr19)

nullmod <- lm(Community_data$density_perc~1)

selAIC2 <- step(nullmod,scope=list(lower=nullmod,upper=fullmod2),direction="forward")
summary(selAIC2) #We see that internet access information and readiness are not even included and that among the included variables, only two are significant: violent crime and unemployment rate. This enables us to conclude that like racial metrics, educational metrics are poor predictors of CCTV levels.

library(car)
vif(selAIC2) #We can try to make a multiple regression containing the only two significant variables: 

CCTV_VS_ViolentCrime_and_Unemp <- lm(Community_data$density_perc~Community_data$ViolentCrimePerCapitaPerArea+Community_data$unempr19)

summary(CCTV_VS_ViolentCrime_and_Unemp) #We see that unemployment becomes insignificant

#Overall, it really seems that the main predictor of CCTV density that we could observe is violent crime. Racial metrics, educational metrics and socio economic indicators are quite poor predictors. We must note that linear regressions with 56 observations might also be problematic to yield great results.

#Yet, this statement must be mitigated. Indeed, with R-squared of approximatnely 50%, we are in situation where we can only explain 50% of the  variation. This means that thee approximantely is 50% of the variation whose origin is unknown to us. 

```

### 4.67 Next steps after feedback on project update

+ Adjust accroding to the feedback 
+ Create new models (potentially multiple linear regression ?)
+ Finalise interpetations and answer research questions
+ Compare results to other researches 
+ Create some more visualisations (if useful and needed)
+ Include Executive summary at the beginning
+ Add additional data if needed
+ Create bibliography
+ hello guys