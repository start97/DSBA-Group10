# Analysis {.tabset}

```{r, echo = FALSE, message = FALSE, warning = FALSE}
source(here::here("scripts/setup.R"))
```

### 4.1 CCTVs VS Crime - Does the presence of CCTV deter crime?

In order to be in position to comment on the effectiveness of CCTVs on crime deterrence, one is first going to investigate the relationship between CCTV density and crime per capita. To do so, we first create a simple linear regression model. We create a new data frame called `CCTV_VS_crimes` (which basically is a left joint). The linear regression indicates a moderate correlation between higher CCTV density and higher crime per capita. The $R^2$ is at 42.9%. Plotting the observations enables one to see this tendency. The blue line represents the regression line.

```{r echo=FALSE, results='asis'}

CCTV_VS_crimes <- CCTV_per_area %>% 
  left_join(CrimeStatsPerArea,by="Community")
  
regression <- lm(CCTV_VS_crimes$CrimePer1000inhabitants~CCTV_VS_crimes$density_perc)

stargazer(regression,
          title = "Regression Crime vs CCTVs",
          type = "html")

ggplot(data=CCTV_VS_crimes,mapping= aes(x=density_perc,y=CrimePer1000inhabitants)) + 
  labs(title = "As CCTV density increases, crime per capita tends to increase as well.", x="CCTV density",y="Crime per capita",)+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```

#### 4.1.1 Mapping of CCTVs and crime, felony and misdemeanor per capita

Another interesting way to illustrate this correlation is by using a map depicting crime per capita in Baltimore and adding an extra layer to represent CCTVs. The method is the same as before with the `tmap` package. However, this time we have two different shapes: `tm_shape(baltimore)` which constitutes the base map and `tm_shape(balt_dat)` which adds a layer containing points. If we take a look at this map we see that it gives an intuition about the phenomenon we illustrated before. It seems as if where crime per capita is the lowest, there seems to be less CCTVs. There seems to be a correlation between the dark red areas and the highest CCTV concentrations. Looking at the north-western and south-western areas of the map, it can be seen that the placement of CCTVs aligns rather well with the areas considered dangerous. We can also use an interactive map. The benefit of using such map is that it enables to get precise information about crime per capita in a given area by clicking on it.

```{r results='markup'}

Crime_per_capita_VS_CCTV_map <- tm_shape(baltimore) + tm_fill(col = "CrimePer1000inhabitants", title ="Crime per capita",style = "quantile") + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.05) + tm_shape(balt_dat) + tm_dots(col="black") 

tmap_mode("plot")

Crime_per_capita_VS_CCTV_map

baltimore@data[["fid"]]<-baltimore@data[["community"]] #We do that so that we see the name of the Community when using an interactive map

Crime_and_CCTV_map <- tm_shape(baltimore) + tm_fill(col = "CrimePer1000inhabitants", title ="Crime per capita per Area in %",style = "quantile") + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.05)+ tm_shape(balt_dat) + tm_dots(col="black")

tmap_mode("view") #Use this command to have interactive maps

Crime_and_CCTV_map
```

<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>

However, even though this correlation is interesting, it does not allow one to say much about the effectiveness of CCTVs. We are stuck in a sort of chicken-and-egg problem. In order to get in position to comment on the crime-deterring potential of CCTV, we decided to analyse the crime per capita evolution of certain areas in relation with their respective CCTV density. Our goal is to observe how crime per capita behaved since 2014 in areas with high CCTV density compared to areas with low CCTV density. In order to select our areas of interest, we performed a k-means clustering based on two dimensions:  CCTV density and crime per capita. We first scale the data, then we add the names of each area as row name. We then use the elbow method to determine the optimal number of cluster using `fviz_nbclust`. When performing the kmeans clustering, we specify a nstart parameter. Indeed, if we fail to do so, there is only one choice of random set of rows chosen in the data set as initial centers. We end up with 5 clusters that we represent using `fviz_cluster`. The ratio between the between sum of square and the within sum of square is good (85%), the higher this value the better. Indeed, we want the variation to come from between groups and not within groups.


```{r}
library(FactoMineR)
library(factoextra)

sc.Community_data_Clustering <- scale(Community_data[,c(2:89)]) #We scale the data

row.names(sc.Community_data_Clustering) <- as.vector(t(Community_data[,1])) #We add names of area for each row

fviz_nbclust(sc.Community_data_Clustering[,c(1,3)], kmeans, method="wss")+
  geom_vline(xintercept = 5, linetype = 2) + # add line for better visualisation
  labs(subtitle = "Elbow method")  #We can determine the optimal number of cluster, 5 clusters seems to be reasonable

set.seed(10)
km.clust2 <- kmeans(sc.Community_data_Clustering[,c(1,3)], 5, nstart = 25)
fviz_cluster(km.clust2, data=sc.Community_data_Clustering[,c(1,3)], repel=TRUE)+labs(x="Crime per capita",y="CCTV density",title = str_wrap(("With 5 clusters, we have a rather good ratio of 85% between between and within SS"),width=80),subtitle=str_wrap(("We will focus on areas in the high crime, high CCTV density cluster as well as those in the lower crime, high CCTV density cluster"),width=90))

```
We  start analysing how crime per capita evolved in areas belonging to the "high crime, high CCTV density" cluster. On top of graphically representing this evolution, one may also compute the percentage change in crime per capita betwen 2014 and 2019. We want to see whether we can observe a decreasing tendency in these areas full of CCTVs. We create maps using `ggplot` and `geom_line`. Then, in order to show these maps in a more concise way, we use `grid.arrange`. The table below shows the percentage change in crime per capita between the 2014 and the 2019 period. For the sake of our analysis we will only consider the 2014-2019 period. Indeed, it seems reasonable to assume that the decrease one observes in most areas for the 2020 period can be attributed to the Covid-19 pandemic.

```{r results='markup'}

Downtown_Seton_Hill_evolution <- as.vector(t(Community_data[14,c(25,23,21,19,17,15,13)]))

Year <- c(2014:2020)

Downtown_Seton_Hill <- data.frame(Downtown_Seton_Hill_evolution,Year)

Downtown_Seton_Hill_map <- ggplot(Downtown_Seton_Hill,aes(x=Year,y=Downtown_Seton_Hill_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) + 
  labs(title = "Downtown/Seton Hill",x="Year",y="Crime per capita")

Oldtown_Middle_East_evolution <- as.vector(t(Community_data[41,c(25,23,21,19,17,15,13)]))

Oldtown_Middle_East <- data.frame(Oldtown_Middle_East_evolution,Year)

Oldtown_Middle_East_map <- ggplot(Oldtown_Middle_East,aes(x=Year,y=Oldtown_Middle_East_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) + 
  labs(title = "Oldtown/Middle East",x="Year",y="Crime per capita")

Sandtown_Winchester_Harlem_Park_evolution <- as.vector(t(Community_data[47,c(25,23,21,19,17,15,13)]))

Sandtown_Winchester_Harlem_Park <- data.frame(Sandtown_Winchester_Harlem_Park_evolution,Year)

Sandtown_Winchester_Harlem_Park_map <- ggplot(Sandtown_Winchester_Harlem_Park,aes(x=Year,y=Sandtown_Winchester_Harlem_Park_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) +
  labs(title = "Sandtown-Winchester/Harlem Park",x="Year",y="Crime per capita")

Cherry_Hill_evolution <- as.vector(t(Community_data[7,c(25,23,21,19,17,15,13)]))

Cherry_Hill <- data.frame(Cherry_Hill_evolution,Year)

Cherry_Hill_map <- ggplot(Cherry_Hill,aes(x=Year,y=Cherry_Hill_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) +
  labs(title = "Cherry Hill",x="Year",y="Crime per capita")

library(pdp)

grid.arrange(Downtown_Seton_Hill_map,Oldtown_Middle_East_map,Sandtown_Winchester_Harlem_Park_map,Cherry_Hill_map,nrow=2,ncol=2)

Crime_Evolution_VS_CCTV <- Community_data[,c(1,25,15,4)] %>% 
  mutate(change_perc=((Community_data$CrimePer1000inhabitants19/Community_data$CrimePer1000inhabitants14)-1)*100)

knitr::kable(Crime_Evolution_VS_CCTV[c(7,14,41,47),c(1,5)],col.names = c('Community','Crime per Capita % change')) %>%
  kable_styling(position = "center")

```

One can see that for two out of these four areas with high crime and high CCTV density, crime per capita has actually increased. It slightly decreased for Cherry Hill and decreased more significantly for Sandtown-Winchester/Harlem Park. In order to be able to make a comment on CCTV effectiveness, we decided to also analyse how crime per capita evolved in areas with high crime and low CCTV density.

```{r results='markup'}

Washington_Village_Pigtown_evolution <- as.vector(t(Community_data[54,c(25,23,21,19,17,15,13)]))

Washington_Village_Pigtown_ <- data.frame(Washington_Village_Pigtown_evolution,Year)

Washington_Village_Pigtown_map <- ggplot(Washington_Village_Pigtown_,aes(x=Year,y=Washington_Village_Pigtown_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) +
  labs(title = " Washington Village/Pigtown",x="Year",y="Crime per capita")

Harbor_East_Little_Italy_evolution <- as.vector(t(Community_data[26,c(25,23,21,19,17,15,13)]))

Harbor_East_Little_Italy <- data.frame(Harbor_East_Little_Italy_evolution,Year)

Harbor_East_Little_Italy_map <- ggplot(Harbor_East_Little_Italy,aes(x=Year,y=Harbor_East_Little_Italy_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) +
  labs(title = "Harbor East/Little Italy",x="Year",y="Crime per capita")

Madison_East_End_evolution <- as.vector(t(Community_data[33,c(25,23,21,19,17,15,13)]))

Madison_East_End <- data.frame(Madison_East_End_evolution,Year)

Madison_East_End_map <- ggplot(Madison_East_End,aes(x=Year,y=Madison_East_End_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) +
  labs(title ="Madison East End",x="Year",y="Crime per capita")

Southwest_Baltimore_evolution <- as.vector(t(Community_data[51,c(25,23,21,19,17,15,13)]))

Southwest_Baltimore <- data.frame(Southwest_Baltimore_evolution,Year)

Southwest_Baltimore_map <- ggplot(Southwest_Baltimore,aes(x=Year,y=Southwest_Baltimore_evolution)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 250), breaks =seq(0,250,50)) +
  labs(title ="Southwest Baltimore",x="Year",y="Crime per capita")

grid.arrange(Washington_Village_Pigtown_map,Harbor_East_Little_Italy_map,Madison_East_End_map,Southwest_Baltimore_map,nrow=2,ncol=2)

knitr::kable(Crime_Evolution_VS_CCTV[c(26,33,51,54),c(1,5)],col.names = c('Community','Crime per Capita % change')) %>%
  kable_styling(position = "center")

```

When comparing the four members of the high crime, high CCTV density cluster with the four members of the high crime, low CCTV density cluster, we observe that for three members of the low CCTV density cluster, crime per capita has increased while crime per capita has decreased for two members of the high CCTV density cluster. While this could potentially indicate that crime decreased more often in areas with high CCTV density compared to areas with low CCTV density and therefore indicate that CCTV may be effective crime deterrent, it is **absolutely crucial** to temper this statement with statistically significant. Indeed, the decrease we observe in Cherry Hill and Sandtown-Winchester/Harlem Park could be the result of pure luck/coincidence or could be attributed to many other factors. In addition, the extremely small number of data items analysed makes it particularly difficult to draw conclusions.  It should also be noted that although crime has fallen in two high crime, high CCTV areas, in one case it has fallen only slightly (Cherry Hill).

Looking at how crime per cpaita has evolved throughout Baltimore City, one observes a general downward trend. This confirms the fact that the downward results should be interpreted with caution because other factors than CCTVs might be the reason for decreases. Finally, we computed a simple linear regression model between CCTV density and crime per capita evolution. We found out no significant correlation.

All this leads us to believe that it is difficult to attribute real effectiveness to CCTVs.

```{r results='markup'}

Crime_Yearly_evolution_map <- crime_data_with_areas %>% 
  count(year=floor_date(CrimeDateTime,"year")) %>% 
  ggplot(aes(year,n))+geom_line()+
  scale_x_date(limits = c(as.Date("2014-01-01"), as.Date("2020-12-31"))) +
  labs(title = "Overall, crime seems to have decreased for 2017 to 2020 period",subtitle=str_wrap(("This explains why we should be careful when considering CCTV effectiveness"),width=80),x="Year",y="Crime occurences")

Crime_Yearly_evolution_map

regression7 <- lm(Crime_Evolution_VS_CCTV$change_perc~Crime_Evolution_VS_CCTV$density_perc)
summary(regression7)

```

#### 4.1.2 Analysis of where crime took place: August 2021

However, still in an effort to observe how CCTVs impact on crime, we set out to locate crimes committed and compare these locations to those of the surveillance cameras. Knowing that a surveillance camera captures activities within 256ft (~2 blocks), it is interesting to observe whether or not there are "crime-free zones" around the cameras. We will only select crime committed in August 2021 to have interpretable data (choosing a larger time frame would make the map unreadable). We choose August 2021 because it is the latest full month which we have in our data set. Taking the latest time points from the data assures us that most of the CCTVs presented in the data set were already there (since we have no information of when exactly these CCTVs were added). Again, as before, we create a data table, assign coordinates, define CRS (in this case the CRS is "EPDS4326", which we needed to transform using `spTransform`). Again, we create a map with `tm_shape` to visualise the results. The output shows where crime takes place (in red) compared to the CCTV location (in black). By zooming on the map, we see that some crimes are committed directly in front of CCTVs. Although this is not conclusive evidence, this observation goes against the idea that CCTVs are effective crime deterrents. 

```{r results='markup'}

crime_spatial <- as.data.table(crime_data_with_areas %>%  filter(CrimeDateTime >= as.Date("2021-08-01") & CrimeDateTime <= as.Date("2021-08-31")))
coordinates(crime_spatial) <-  c("Longitude","Latitude")
proj4string(crime_spatial) <-  CRS("+init=epsg:4326")
crime_spatial <- spTransform(crime_spatial,crs.geo1)

August21Crimes_VS_CCTV <- tm_shape(baltimore) + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.1, title="Crimes committed in August 2021 VS CCTV location",frame.lwd = 5)+ tm_shape(balt_dat) + tm_dots(col="black")+tm_shape(crime_spatial)+tm_dots(col="red",alpha=0.5)

#It could be interesting to see where crime took place relative to CCTV locations in the area with the highest crime rate in August 2021

tmap_mode("view") #Use this command to have interactive maps
August21Crimes_VS_CCTV
```

To further prove that point we decided to focus on one specific area. We arbitrarily decided to focus on the area which had the highest crime incidence in August. Thus, we needed to calculate the crime rate for August per area to see where crime per capita was highest. The results show that they are in Downtown. 

So following this we take a closer look at the Downtown area.

```{r}
CrimePerCapitaPerAreaAugust2021 <- crime_data_with_areas %>%  filter(CrimeDateTime >= as.Date("2021-08-01") & CrimeDateTime <= as.Date("2021-08-31")) %>% 
  group_by(Community) %>%
  summarize(CrimeFrequency=n())

CrimePerCapitaPerAreaAugust2021 <-mutate(CrimePerCapitaPerAreaAugust2021,CrimePer1000inhabitants=((CrimePerCapitaPerAreaAugust2021$CrimeFrequency/population_data$tpop20)*1000))
#We see that Downtown is the area with the highest crime rate in August 2021, we might want to focus on that area and see whether there is crime that take place directly next to CCTVs


```
We create a "sub-map" in the exact same way as we did for the prison in section 3.2.3. In Downtown, we quite clearly see that some crimes (red points) are committed right next to some CCTVs (black triangles).

```{r}
Downtown_area <-  st_bbox(c(xmin = -8531335.08, xmax = -8526873.06,
                      ymin =4765236.47, ymax = 4762527.65),
                    crs = st_crs(baltimore)) %>% st_as_sfc()
 
Downtown_map <- tm_shape(Downtown_area) + tm_borders(col="white")+ tm_shape(baltimore) + tm_borders(col="black") + tm_layout(inner.margins = 0.05,frame.lwd = 5,title = "Zoom on Downtown Area",title.position = c('left', 'top'))+tm_scale_bar(position = c("left", "top"))+ tm_shape(balt_dat) + tm_symbols(shape = 2, col = "black", size = 0.07)+tm_shape(crime_spatial)+tm_dots(col="red")

Baltimore_map_2 <- tm_shape(baltimore) + tm_borders()+ tm_shape(Downtown_area) + tm_borders(lwd = 1.5,col = "red") + tm_layout(frame.lwd = 6,inner.margins = 0.05)

tmap_mode("plot")
Downtown_map
print(Baltimore_map_2, vp = viewport(0.8, 0.27, width = 0.5, height = 0.5)) #By running these two lines together, we obtain the map with an additional overview
```
The fact that we observe crimes committed right next to surveillance cameras reinforces the hypothesis put forward so far and allows us to answer our first research question once and for all: it does not seem that CCTVs reduce crime.

### 4.2 What types of crimes may be deterred by surveillance cameras?

Although it is impossible to prove the effectiveness of surveillance cameras on crime in general, it is interesting to investigate whether different results are obtained when crime is broken down by type. The methodology we will use is the same as with crime in general.We start with felonies and misdemeanors, then we analyse violent and property crimes.

#### 4.2.1 CCTVs VS Felonies and Misdemeanors

The results of the simple linear regression shows a weak $R^2$ for both felonies and misdemeanors. Plotting the observations enables one to see this (weak) tendency. The blue line represents the regression line. 

```{r echo=FALSE, results = 'markup'}

#Felonies

CCTV_VS_Felony <- CCTV_per_area %>% 
  left_join(FelonyStats,by="Community")

regression5 <- lm(CCTV_VS_Felony$FelonyPerCapitaPerArea~CCTV_VS_Felony$density_perc)

stargazer(regression5,
          title = "CCTV vs FelonyPerCapitaPerArea",
          type = "text")

ggplot(data=CCTV_VS_Felony,mapping= aes(x=density_perc,y=FelonyPerCapitaPerArea)) + 
  labs(title = "CCTV Density per Community VS Felony per Capita per Community", x="CCTV Density ",y="Felony per capita")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)

#Misdemeanors

CCTV_VS_misdemeanors <- CCTV_per_area %>% 
  left_join(MisdemeanorStats,by="Community")

regression6 <- lm(CCTV_VS_misdemeanors$MisdemeanorPerCapitaPerArea~CCTV_VS_misdemeanors$density_perc)

stargazer(regression6,
          title = "CCTV vs MisdemeanorperCapitaPerArea",
          type = "text")

ggplot(data=CCTV_VS_misdemeanors,mapping= aes(x=density_perc,y=MisdemeanorPerCapitaPerArea)) + 
   labs(title = "CCTV Density per Community VS Misdemeanor per Capita per Community", x="CCTV Density ",y="Misdemeanor per capita")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```

We are in the exact same situation as with crime, in order to comment on the effectiveness of CCTVs on felonies and/or misdemeanors, we must analyse felony/misdemeanor evolution over time in areas with/without CCTVs. We start with felonies. 

```{r echo=FALSE, results = 'markup'}

fviz_nbclust(sc.Community_data_Clustering[,c(5,3)], kmeans, method="wss")+
  geom_vline(xintercept = 5, linetype = 2) + # add line for better visualisation
  labs(subtitle = "Elbow method")  #We can determine the optimal number of cluster, 5 clusters seems to be reasonable

set.seed(40)
km.clust5 <- kmeans(sc.Community_data_Clustering[,c(5,3)], 5, nstart = 25) #It is important to specify a nstart parameter. Indeed, if we fail to do so, there is only one choice of random set of rows chosen in the dataset as initial centers.
print(km.clust5) #The ratio between the between sum of square and the within sum of square is good, the higher this value the better. Indeed, we want the variation to come from Between Groups and not Within Groups.
fviz_cluster(km.clust5, data=sc.Community_data_Clustering[,c(5,3)], repel=TRUE) + labs(x="Felony per capita",y="CCTV density",title = str_wrap(("With 5 clusters, we have a rather good ratio of 87.1% between between and within SS"),width=80),subtitle=str_wrap(("We will focus on areas in the high felony, high CCTV density cluster as well as those in the lower felony, high CCTV density cluster"),width=90))

Downtown_Seton_Hill_evolution_Felony <- as.vector(t(Community_data[14,c(73,71,69,67,65,63,61)]))

Downtown_Seton_Hill_Felony <- data.frame(Downtown_Seton_Hill_evolution_Felony,Year)

Downtown_Seton_Hill_map_Felony <- ggplot(Downtown_Seton_Hill_Felony,aes(x=Year,y=Downtown_Seton_Hill_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Downtown/Seton Hill",x="Year",y="Felony per capita")

Sandtown_Winchester_Harlem_Park_evolution_Felony <- as.vector(t(Community_data[47,c(73,71,69,67,65,63,61)]))

Sandtown_Winchester_Harlem_Park_Felony <- data.frame(Sandtown_Winchester_Harlem_Park_evolution_Felony,Year)

Sandtown_Winchester_Harlem_Park_map_Felony <- ggplot(Sandtown_Winchester_Harlem_Park_Felony,aes(x=Year,y=Sandtown_Winchester_Harlem_Park_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Sandtown-Winchester/Harlem Park",x="Year",y="Felony per capita")

Oldtown_Middle_East_evolution_Felony <- as.vector(t(Community_data[41,c(73,71,69,67,65,63,61)]))

Oldtown_Middle_East_Felony <- data.frame(Oldtown_Middle_East_evolution_Felony,Year)

Oldtown_Middle_East_map_Felony <- ggplot(Oldtown_Middle_East_Felony,aes(x=Year,y=Oldtown_Middle_East_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Oldtown/Middle East",x="Year",y="Felony per capita")

Cherry_Hill_evolution_Felony <- as.vector(t(Community_data[7,c(73,71,69,67,65,63,61)]))

Cherry_Hill_Felony <- data.frame(Cherry_Hill_evolution_Felony,Year)

Cherry_Hill_map_Felony <- ggplot(Cherry_Hill_Felony,aes(x=Year,y=Cherry_Hill_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Cherry Hill",x="Year",y="Felony per capita")

grid.arrange(Downtown_Seton_Hill_map_Felony,Sandtown_Winchester_Harlem_Park_map_Felony,Oldtown_Middle_East_map_Felony,Cherry_Hill_map_Felony,nrow=2,ncol=2)

Felony_Evolution_VS_CCTV <- Community_data[,c(1,63,73,4)] %>% 
  mutate(change_perc=((Community_data$FelonyPer1000inhabitants19/Community_data$FelonyPer1000inhabitants14)-1)*100)

Felony_Evolution_VS_CCTV[c(7,14,41,47),c(-3)]

Poppleton_evolution_Felony <- as.vector(t(Community_data[46,c(73,71,69,67,65,63,61)]))

Poppleton_Felony <- data.frame(Poppleton_evolution_Felony,Year)

Poppleton_map_Felony <- ggplot(Poppleton_Felony,aes(x=Year,y=Poppleton_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Poppleton/The Terraces/Hollins Market",x="Year",y="Felony per capita")

Madison_East_End_evolution_Felony <- as.vector(t(Community_data[33,c(73,71,69,67,65,63,61)]))

Madison_East_End_Felony <- data.frame(Madison_East_End_evolution_Felony,Year)

Madison_East_End_map_Felony <- ggplot(Madison_East_End_Felony,aes(x=Year,y=Madison_East_End_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Madinson/East End",x="Year",y="Felony per capita")

Clifton_Berea_evolution_Felony <- as.vector(t(Community_data[10,c(73,71,69,67,65,63,61)]))

Clifton_Berea_Felony <- data.frame(Clifton_Berea_evolution_Felony,Year)

Clifton_Berea_map_Felony <- ggplot(Clifton_Berea_Felony,aes(x=Year,y=Clifton_Berea_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Clifton-Berea",x="Year",y="Felony per capita")

Midway_Coldstream_evolution_Felony <- as.vector(t(Community_data[36,c(73,71,69,67,65,63,61)]))

Midway_Coldstream_Felony <- data.frame(Midway_Coldstream_evolution_Felony,Year)

Midway_Coldstream_map_Felony <- ggplot(Midway_Coldstream_Felony,aes(x=Year,y=Midway_Coldstream_evolution_Felony)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Midway/Coldstream",x="Year",y="Felony per capita")

grid.arrange(Poppleton_map_Felony,Madison_East_End_map_Felony,Clifton_Berea_map_Felony,Midway_Coldstream_map_Felony,nrow=2,ncol=2)

Felony_Evolution_VS_CCTV[c(10,33,36,46),c(-3)]

```

We can check how felony evolved over time.

```{r results='markup'}

Felony_Yearly_evolution_map <- crime_data_with_areas %>%
  filter(Category=="Felony") %>% 
  count(year=floor_date(CrimeDateTime,"year")) %>% 
  ggplot(aes(year,n))+geom_line()+
  scale_x_date(limits = c(as.Date("2014-01-01"), as.Date("2020-12-31"))) +
  labs(title = "In Baltimore, Felony started to decrease as from 2017",subtitle=str_wrap(("This explains why we should be careful when considering CCTV effectiveness in deterring felonies"),width=80),x="Year",y="Felony occurences")

Felony_Yearly_evolution_map

regression10 <- lm(Felony_Evolution_VS_CCTV$change_perc~Felony_Evolution_VS_CCTV$density_perc)
summary(regression10)

```

We continue with misdemeanors.

```{r echo=FALSE, results = 'markup'}

fviz_nbclust(sc.Community_data_Clustering[,c(6,3)], kmeans, method="wss")+
  geom_vline(xintercept = 5, linetype = 2) + # add line for better visualisation
  labs(subtitle = "Elbow method")  #We can determine the optimal number of cluster, 5 clusters seems to be reasonable

set.seed(50)
km.clust6 <- kmeans(sc.Community_data_Clustering[,c(6,3)], 5, nstart = 25) #It is important to specify a nstart parameter. Indeed, if we fail to do so, there is only one choice of random set of rows chosen in the dataset as initial centers.
print(km.clust6) #The ratio between the between sum of square and the within sum of square is good, the higher this value the better. Indeed, we want the variation to come from Between Groups and not Within Groups.
fviz_cluster(km.clust6, data=sc.Community_data_Clustering[,c(6,3)], repel=TRUE) + labs(x="Misdemeanor per capita",y="CCTV density",title = str_wrap(("With 5 clusters, we have a rather good ratio of 84.41% between between and within SS"),width=80),subtitle=str_wrap(("We will focus on areas in the high misdemeanor, high CCTV density cluster as well as those in the lower misdemeanor, high CCTV density cluster"),width=90))

Downtown_Seton_Hill_evolution_Misdemeanor <- as.vector(t(Community_data[14,c(89,87,85,83,81,79,77)]))

Downtown_Seton_Hill_Misdemeanor <- data.frame(Downtown_Seton_Hill_evolution_Misdemeanor,Year)

Downtown_Seton_Hill_map_Misdemeanor <- ggplot(Downtown_Seton_Hill_Misdemeanor,aes(x=Year,y=Downtown_Seton_Hill_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Downtown/Seton Hill",x="Year",y="Misdemeanor per capita")

Oldtown_Middle_East_evolution_Misdemeanor <- as.vector(t(Community_data[41,c(89,87,85,83,81,79,77)]))

Oldtown_Middle_East_Misdemeanor <- data.frame(Oldtown_Middle_East_evolution_Misdemeanor,Year)

Oldtown_Middle_East_map_Misdemeanor <- ggplot(Oldtown_Middle_East_Misdemeanor,aes(x=Year,y=Oldtown_Middle_East_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Oldtown/Middle East",x="Year",y="Misdemeanor per capita")

Upton_Druid_Heights_evolution_Misdemeanor <- as.vector(t(Community_data[53,c(89,87,85,83,81,79,77)]))

Upton_Druid_Heights_Misdemeanor <- data.frame(Upton_Druid_Heights_evolution_Misdemeanor,Year)

Upton_Druid_Heights_map_Misdemeanor <- ggplot(Upton_Druid_Heights_Misdemeanor,aes(x=Year,y=Upton_Druid_Heights_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Upton/Druid Heights",x="Year",y="Misdemeanor per capita")

Sandtown_Winchester_Harlem_Park_evolution_Misdemeanor <- as.vector(t(Community_data[47,c(89,87,85,83,81,79,77)]))

Sandtown_Winchester_Harlem_Park_Misdemeanor <- data.frame(Sandtown_Winchester_Harlem_Park_evolution_Misdemeanor,Year)

Sandtown_Winchester_Harlem_Park_map_Misdemeanor <- ggplot(Sandtown_Winchester_Harlem_Park_Misdemeanor,aes(x=Year,y=Sandtown_Winchester_Harlem_Park_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Sandtown-Winchester/Harlem-Park",x="Year",y="Misdemeanor per capita")

grid.arrange(Downtown_Seton_Hill_map_Misdemeanor,Oldtown_Middle_East_map_Misdemeanor,Upton_Druid_Heights_map_Misdemeanor,Sandtown_Winchester_Harlem_Park_map_Misdemeanor,nrow=2,ncol=2)

Misdemeanor_Evolution_VS_CCTV <- Community_data[,c(1,79,89,4)] %>% 
  mutate(change_perc=((Community_data$MisdemeanorPer1000inhabitants19/Community_data$MisdemeanorPer1000inhabitants14)-1)*100)

Misdemeanor_Evolution_VS_CCTV[c(14,41,47,53),c(-3)]

Washington_Village_Pigtown_evolution_Misdemeanor <- as.vector(t(Community_data[54,c(89,87,85,83,81,79,77)]))

Washington_Village_Pigtown_Misdemeanor <- data.frame(Washington_Village_Pigtown_evolution_Misdemeanor,Year)

Washington_Village_Pigtown_map_Misdemeanor <- ggplot(Washington_Village_Pigtown_Misdemeanor,aes(x=Year,y=Washington_Village_Pigtown_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Washington Village/Pigtown",x="Year",y="Misdemeanor per capita")

Harbor_East_Little_Italy_evolution_Misdemeanor <- as.vector(t(Community_data[26,c(89,87,85,83,81,79,77)]))

Harbor_East_Little_Italy_Misdemeanor <- data.frame(Harbor_East_Little_Italy_evolution_Misdemeanor,Year)

Harbor_East_Little_Italy_map_Misdemeanor <- ggplot(Harbor_East_Little_Italy_Misdemeanor,aes(x=Year,y=Harbor_East_Little_Italy_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Harbor East/Little Italy",x="Year",y="Misdemeanor per capita")

Canton_evolution_Misdemeanor <- as.vector(t(Community_data[5,c(89,87,85,83,81,79,77)]))

Canton_Misdemeanor <- data.frame(Canton_evolution_Misdemeanor,Year)

Canton_map_Misdemeanor <- ggplot(Canton_Misdemeanor,aes(x=Year,y=Canton_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Canton",x="Year",y="Misdemeanor per capita")

Penn_North_Reservoir_Hill_evolution_Misdemeanor <- as.vector(t(Community_data[44,c(89,87,85,83,81,79,77)]))

Penn_North_Reservoir_Hill_Misdemeanor <- data.frame(Penn_North_Reservoir_Hill_evolution_Misdemeanor,Year)

Penn_North_Reservoir_Hill_map_Misdemeanor <- ggplot(Penn_North_Reservoir_Hill_Misdemeanor,aes(x=Year,y=Penn_North_Reservoir_Hill_evolution_Misdemeanor)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 150), breaks =seq(0,150,25)) + 
  labs(title = "Penn North/Reservoir Hill",x="Year",y="Misdemeanor per capita")

grid.arrange(Washington_Village_Pigtown_map_Misdemeanor,Harbor_East_Little_Italy_map_Misdemeanor,Canton_map_Misdemeanor,Penn_North_Reservoir_Hill_map_Misdemeanor,nrow=2,ncol=2)

Misdemeanor_Evolution_VS_CCTV[c(5,26,44,54),c(-3)]

```
We can check how misdemeanor evolved over time.

```{r results='markup'}

Misdemeanor_Yearly_evolution_map <- crime_data_with_areas %>%
  filter(Category=="Misdemeanor") %>% 
  count(year=floor_date(CrimeDateTime,"year")) %>% 
  ggplot(aes(year,n))+geom_line()+
  scale_x_date(limits = c(as.Date("2014-01-01"), as.Date("2020-12-31"))) +
  labs(title = "In Baltimore, Misdemeanor started to decrease as from 2017",subtitle=str_wrap(("This explains why we should be careful when considering CCTV effectiveness in deterring misdemenors"),width=80),x="Year",y="Misdemeanor occurences")

Misdemeanor_Yearly_evolution_map

regression11 <- lm(Misdemeanor_Evolution_VS_CCTV$change_perc~Misdemeanor_Evolution_VS_CCTV$density_perc)
summary(regression11)

```

#### 4.2.2 CCTVs VS Violent and Property Crime

```{r echo=FALSE, results = 'markup'}

CCTV_VS_ViolentCrime <- CCTV_per_area %>% 
  left_join(ViolentStats,by="Community")

regression21 <- lm(CCTV_VS_ViolentCrime$ViolentCrimePerCapitaPerArea~CCTV_VS_ViolentCrime$density_perc)

stargazer(regression21,
          title = "CCTV vs ViolentCrimePerArea",
          type = "text")

CCTV_VS_PropertyCrime <- CCTV_per_area %>% 
  left_join(PropertyStats,by="Community")

regression22 <- lm(CCTV_VS_PropertyCrime$PropertyCrimePerCapitaPerArea~CCTV_VS_PropertyCrime$density_perc)

stargazer(regression22,
          title = "Property Crime vs CCTVs",
          type = "html")

#We observe a stronger correlation between Violent Crime and CCTV density compared to Property crime and CCTV density

ggplot(Community_data,aes(x=density_perc,y=ViolentCrimePerCapitaPerArea))+
  geom_point()+
  geom_smooth(se=F)+
  labs(x="CCTV Density per Area",y="Violent Crime per Capita per Area",title="Violent crime increases with CCTV density",subtitle = str_wrap("Yet, we observe that the lack of data about CCTV in some areas has an impact."),width=45)

ggplot(Community_data,aes(x=density_perc,y=PropertyCrimePerCapitaPerArea))+
  geom_point()+
  geom_smooth(se=F)+
  labs(x="CCTV Density per Area",y="Property Crime per Capita per Area",title="Property crime is weakly correlated with CCTV intensity",subtitle = str_wrap("The correlation seems weaker than between violent crime and CCTV density"),width=45)

```
We proceed in the same way as we did with felony and misdemeanors.

```{r echo=FALSE, results = 'markup'}

fviz_nbclust(sc.Community_data_Clustering[,c(7,3)], kmeans, method="wss")+
  geom_vline(xintercept = 5, linetype = 2) + # add line for better visualisation
  labs(subtitle = "Elbow method")  #We can determine the optimal number of cluster, 5 clusters seems to be reasonable

set.seed(20)
km.clust3 <- kmeans(sc.Community_data_Clustering[,c(7,3)], 5, nstart = 25) #It is important to specify a nstart parameter. Indeed, if we fail to do so, there is only one choice of random set of rows chosen in the dataset as initial centers.
print(km.clust3) #The ratio between the between sum of square and the within sum of square is good, the higher this value the better. Indeed, we want the variation to come from Between Groups and not Within Groups.
fviz_cluster(km.clust3, data=sc.Community_data_Clustering[,c(7,3)], repel=TRUE) + labs(x="Violent crime per capita",y="CCTV density",title = str_wrap(("With 5 clusters, we have a rather good ratio of 87.4% between between and within SS"),width=80),subtitle=str_wrap(("We will focus on areas in the high violent crime, high CCTV density cluster as well as those in the lower violent crime, high CCTV density cluster"),width=90))

Downtown_Seton_Hill_evolution_Violent <- as.vector(t(Community_data[14,c(41,39,37,35,33,31,29)]))

Downtown_Seton_Hill_Violent <- data.frame(Downtown_Seton_Hill_evolution_Violent,Year)

Downtown_Seton_Hill_map_Violent <- ggplot(Downtown_Seton_Hill_Violent,aes(x=Year,y=Downtown_Seton_Hill_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Downtown/Seton Hill",x="Year",y="Violent Crime per capita")

Oldtown_Middle_East_evolution_Violent <- as.vector(t(Community_data[41,c(41,39,37,35,33,31,29)]))

Oldtown_Middle_East_Violent <- data.frame(Oldtown_Middle_East_evolution_Violent,Year)

Oldtown_Middle_East_map_Violent <- ggplot(Oldtown_Middle_East_Violent,aes(x=Year,y=Oldtown_Middle_East_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Oldtown/Middle East",x="Year",y="Violent Crime per capita")

Sandtown_Winchester_Harlem_Park_evolution_Violent <- as.vector(t(Community_data[47,c(41,39,37,35,33,31,29)]))

Sandtown_Winchester_Harlem_Park_Violent <- data.frame(Sandtown_Winchester_Harlem_Park_evolution_Violent,Year)

Sandtown_Winchester_Harlem_Park_map_Violent <- ggplot(Sandtown_Winchester_Harlem_Park_Violent,aes(x=Year,y=Sandtown_Winchester_Harlem_Park_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Sandtown-Winchester/Harlem Park",x="Year",y="Violent Crime per capita")

Cherry_Hill_evolution_Violent <- as.vector(t(Community_data[7,c(41,39,37,35,33,31,29)]))

Cherry_Hill_Violent <- data.frame(Cherry_Hill_evolution_Violent,Year)

Cherry_Hill_map_Violent <- ggplot(Cherry_Hill_Violent,aes(x=Year,y=Cherry_Hill_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Cherry Hill",x="Year",y="Violent Crime per capita")

library(pdp)

grid.arrange(Downtown_Seton_Hill_map_Violent,Oldtown_Middle_East_map_Violent,Sandtown_Winchester_Harlem_Park_map_Violent,Cherry_Hill_map_Violent,nrow=2,ncol=2)

Violent_Crime_Evolution_VS_CCTV <- Community_data[,c(1,31,41,4)] %>% 
  mutate(change_perc=((Community_data$ViolentCrimePer1000inhabitants19/Community_data$ViolentCrimePer1000inhabitants14)-1)*100)

Violent_Crime_Evolution_VS_CCTV[c(7,14,41,47),c(-3)]

#We observe a tendency for violent crime to slightly decrease in Sandtown-Winchester and Cherry Hill while for Downtown/Seton Hill and Oldtown/Middle East, things seem to have stood still and became worse, respectively.

Clifton_Berea_evolution_Violent <- as.vector(t(Community_data[10,c(41,39,37,35,33,31,29)]))

Clifton_Berea_Violent <- data.frame(Clifton_Berea_evolution_Violent,Year)

Clifton_Berea_map_Violent <- ggplot(Clifton_Berea_Violent,aes(x=Year,y=Clifton_Berea_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Clifton-Berea",x="Year",y="Violent Crime per capita")

Pimlico_Arlington_Hilltop_evolution_Violent <- as.vector(t(Community_data[45,c(41,39,37,35,33,31,29)]))

Pimlico_Arlington_Hilltop_Violent <- data.frame(Pimlico_Arlington_Hilltop_evolution_Violent,Year)

Pimlico_Arlington_Hilltop_map_Violent <- ggplot(Pimlico_Arlington_Hilltop_Violent,aes(x=Year,y=Pimlico_Arlington_Hilltop_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Pimlico/Arlington/Hilltop",x="Year",y="Violent Crime per capita")

Midway_Coldstream_evolution_Violent <- as.vector(t(Community_data[36,c(41,39,37,35,33,31,29)]))

Midway_Coldstream_Violent <- data.frame(Midway_Coldstream_evolution_Violent,Year)

Midway_Coldstream_map_Violent <- ggplot(Midway_Coldstream_Violent,aes(x=Year,y=Midway_Coldstream_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Midway/Coldstream",x="Year",y="Violent Crime per capita")

Madison_East_End_evolution_Violent <- as.vector(t(Community_data[33,c(41,39,37,35,33,31,29)]))

Madison_East_End_Violent <- data.frame(Madison_East_End_evolution_Violent,Year)

Madison_East_End_map_Violent <- ggplot(Madison_East_End_Violent,aes(x=Year,y=Madison_East_End_evolution_Violent)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Madison/East End",x="Year",y="Violent Crime per capita")

grid.arrange(Clifton_Berea_map_Violent,Pimlico_Arlington_Hilltop_map_Violent,Midway_Coldstream_map_Violent,Madison_East_End_map_Violent,nrow=2,ncol=2)

Violent_Crime_Evolution_VS_CCTV[c(10,33,36,45),c(-3)]

#Comparing violent crime evolution in areas member of the high violent crime, high CCTV density cluster with violent crime evolution in areas member of th high violent crime, low CCTV density cluster, it seems like we could not detect any significant difference. The presence of CCTV does not seem to have an impact on violent crime.

```

We can check how violent crime evolved over time.

```{r results='markup'}

Violent_Crime_Yearly_evolution_map <- crime_data_with_areas %>%
  filter(VIO_PROP_CFS=="VIOLENT") %>% 
  count(year=floor_date(CrimeDateTime,"year")) %>% 
  ggplot(aes(year,n))+geom_line()+
  scale_x_date(limits = c(as.Date("2014-01-01"), as.Date("2020-12-31"))) +
  labs(title = "Overall, violent crime seems to have decreased for the 2017 to 2020 period",subtitle=str_wrap(("This explains why we should be careful when considering CCTV effectiveness in deterring violent crime"),width=80),x="Year",y="Violent crime occurences")

Violent_Crime_Yearly_evolution_map

regression8 <- lm(Violent_Crime_Evolution_VS_CCTV$change_perc~Violent_Crime_Evolution_VS_CCTV$density_perc)
summary(regression8)

```

We continue with property crimes.

```{r echo=FALSE, results = 'markup'}

fviz_nbclust(sc.Community_data_Clustering[,c(8,3)], kmeans, method="wss")+
  geom_vline(xintercept = 5, linetype = 2) + # add line for better visualisation
  labs(subtitle = "Elbow method")  #We can determine the optimal number of cluster, 5 clusters seems to be reasonable

set.seed(30)
km.clust4 <- kmeans(sc.Community_data_Clustering[,c(8,3)], 5, nstart = 25) #It is important to specify a nstart parameter. Indeed, if we fail to do so, there is only one choice of random set of rows chosen in the dataset as initial centers.
print(km.clust4) #The ratio between the between sum of square and the within sum of square is good, the higher this value the better. Indeed, we want the variation to come from Between Groups and not Within Groups.
fviz_cluster(km.clust4, data=sc.Community_data_Clustering[,c(8,3)], repel=TRUE) + labs(x="Property crime per capita",y="CCTV density",title = str_wrap(("With 5 clusters, we have a rather good ratio of 82.8% between between and within SS"),width=80),subtitle=str_wrap(("We will focus on areas in the high property crime, high CCTV density cluster as well as those in the lower property crime, high CCTV density cluster"),width=90))

Downtown_Seton_Hill_evolution_Property <- as.vector(t(Community_data[14,c(57,55,53,51,49,47,45)]))

Downtown_Seton_Hill_Property <- data.frame(Downtown_Seton_Hill_evolution_Property,Year)

Downtown_Seton_Hill_map_Property <- ggplot(Downtown_Seton_Hill_Property,aes(x=Year,y=Downtown_Seton_Hill_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Downtown/Seton Hill",x="Year",y="Property Crime per capita")

Oldtown_Middle_East_evolution_Property <- as.vector(t(Community_data[41,c(57,55,53,51,49,47,45)]))

Oldtown_Middle_East_Property <- data.frame(Oldtown_Middle_East_evolution_Property,Year)

Oldtown_Middle_East_map_Property <- ggplot(Oldtown_Middle_East_Property,aes(x=Year,y=Oldtown_Middle_East_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Oldtown/Middle East",x="Year",y="Property Crime per capita")

Sandtown_Winchester_Harlem_Park_evolution_Property <- as.vector(t(Community_data[47,c(57,55,53,51,49,47,45)]))

Sandtown_Winchester_Harlem_Park_Property <- data.frame(Sandtown_Winchester_Harlem_Park_evolution_Property,Year)

Sandtown_Winchester_Harlem_Park_map_Property <- ggplot(Sandtown_Winchester_Harlem_Park_Property,aes(x=Year,y=Sandtown_Winchester_Harlem_Park_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Sandtown-Winchester/Harlem Park",x="Year",y="Property Crime per capita")

Uptown_Druid_Heights_evolution_Property <- as.vector(t(Community_data[53,c(57,55,53,51,49,47,45)]))

Uptown_Druid_Heights_Property <- data.frame(Uptown_Druid_Heights_evolution_Property,Year)

Uptown_Druid_Heights_map_Property <- ggplot(Uptown_Druid_Heights_Property,aes(x=Year,y=Uptown_Druid_Heights_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "SUptown/Druid Heights",x="Year",y="Property Crime per capita")

grid.arrange(Downtown_Seton_Hill_map_Property,Oldtown_Middle_East_map_Property,Sandtown_Winchester_Harlem_Park_map_Property,Uptown_Druid_Heights_map_Property,nrow=2,ncol=2)

Property_Crime_Evolution_VS_CCTV <- Community_data[,c(1,57,47,4)] %>% 
  mutate(change_perc=((Community_data$PropertyCrimePer1000inhabitants19/Community_data$PropertyCrimePer1000inhabitants14)-1)*100)

Property_Crime_Evolution_VS_CCTV[c(14,41,47,53),c(-3)]

Washington_Village_Pigtown_evolution_Property <- as.vector(t(Community_data[54,c(57,55,53,51,49,47,45)]))

Washington_Village_Pigtown_Property <- data.frame(Washington_Village_Pigtown_evolution_Property,Year)

Washington_Village_Pigtown_map_Property <- ggplot(Washington_Village_Pigtown_Property,aes(x=Year,y=Washington_Village_Pigtown_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Washington Village/Pigtown",x="Year",y="Property Crime per capita")

Harbor_East_Little_Italy_evolution_Property <- as.vector(t(Community_data[26,c(57,55,53,51,49,47,45)]))

Harbor_East_Little_Italy_Property <- data.frame(Harbor_East_Little_Italy_evolution_Property,Year)

Harbor_East_Little_Italy_map_Property <- ggplot(Harbor_East_Little_Italy_Property,aes(x=Year,y=Harbor_East_Little_Italy_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Harbor East/Little Italy",x="Year",y="Property Crime per capita")

Canton_evolution_Property <- as.vector(t(Community_data[5,c(57,55,53,51,49,47,45)]))

Canton_Property <- data.frame(Canton_evolution_Property,Year)

Canton_map_Property <- ggplot(Canton_Property,aes(x=Year,y=Canton_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Canton",x="Year",y="Property Crime per capita")

Southeastern_evolution_Property <- as.vector(t(Community_data[49,c(57,55,53,51,49,47,45)]))

Southeastern_Property <- data.frame(Southeastern_evolution_Property,Year)

Southeastern_map_Property <- ggplot(Southeastern_Property,aes(x=Year,y=Southeastern_evolution_Property)) + 
  geom_line() +
  scale_y_continuous(limits = c(0, 125), breaks =seq(0,125,25)) + 
  labs(title = "Southeastern",x="Year",y="Property Crime per capita")

grid.arrange(Washington_Village_Pigtown_map_Property,Harbor_East_Little_Italy_map_Property,Canton_map_Property,Southeastern_map_Property,nrow=2,ncol=2)

Property_Crime_Evolution_VS_CCTV[c(5,26,49,54),c(-3)]

```

We can check how property crime evolved over time.

```{r results='markup'}

Property_Crime_Yearly_evolution_map <- crime_data_with_areas %>%
  filter(VIO_PROP_CFS=="PROPERTY") %>% 
  count(year=floor_date(CrimeDateTime,"year")) %>% 
  ggplot(aes(year,n))+geom_line()+
  scale_x_date(limits = c(as.Date("2014-01-01"), as.Date("2020-12-31"))) +
  labs(title = "Overall, property crime seems to have decreased for the 2017 to 2020 period",subtitle=str_wrap(("This explains why we should be careful when considering CCTV effectiveness in deterring property crime"),width=80),x="Year",y="Property crime occurences")

Property_Crime_Yearly_evolution_map

regression9 <- lm(Property_Crime_Evolution_VS_CCTV$change_perc~Property_Crime_Evolution_VS_CCTV$density_perc)
summary(regression9)

```

### 4.3 Research question 3 - Is the impact of CCTV on crime reduction higher/lower/same in higher income neighborhoods compared to lower income neighborhoods?

As the actual effectiveness of CCTV is not so clear, answering our third research question does not really make sense. Yet what we can still investigate is how crime as evolved in each area based on its poverty level. Indeed, it is interesting to see whether, for example, inequalities in terms of security between richer and poorer areas have evolved over time.

```{r echo=FALSE, results = 'markup'}

Evolution_VS_poverty <- Community_data[,c(25,15,5)] %>% 
  mutate(change=(Community_data$CrimePer1000inhabitants19/Community_data$CrimePer1000inhabitants14)-1)


ggplot(data=Evolution_VS_poverty,mapping= aes(x=change,y=hhpov19))+
  geom_point()+
  geom_smooth(method = lm,color="blue",size=0.3)+
  labs(x="Change in crime per capita between 2014 and 2019",y="Percentage of people living below the poverty line",title = str_wrap(("Change in crime per capita and poverty do not really seem to be correlated"),width = 60),subtitle = str_wrap(("Altough the regression line might indicate a sort tendency indicating that crime might have reduced more in richer areas compared to poorer areas, the regression output below indicates a very poor correlation"),width = 80))

Evolution_VS_poverty_regr <- lm(Evolution_VS_poverty$hhpov19~Evolution_VS_poverty$change)

summary(Evolution_VS_poverty_regr)

```

The very poor R2 indicates that there is a poor correlation between the change in crime per capita between 2014 and 2019 and the poverty metric used.

### 4.4 Comparison of CCTV density and wealth

We went to see whether there is a correlation between CCTV density and wealth. One of our initial hypothesis was that the government respected more the privacy of wealthier people. So, similarly, we perform a regression. The results here are not so conclusive, since we have a poor $adjusted R^2$ and a poor $R^2$. The next sub-section illustrates this in a map.

```{r echo=FALSE, results = 'markup'}

CCTV_VS_poverty <- CCTV_per_area %>% 
  left_join(poverty_data,by=c("Community"="CSA2010"))

regression2 <- lm(CCTV_VS_poverty$density_perc~CCTV_VS_poverty$hhpov19)

stargazer(regression2,
          title = "CCTV vs poverty ",
          type = "text")

ggplot(data=CCTV_VS_poverty,mapping= aes(x=hhpov19,y=density_perc)) + 
  labs(title = "CCTV density VS poverty rate", x="Poverty rate",y="CCTV Density")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```

#### 4.4.1 Mapping of CCTVs and wealth

The methodology to create the map is always the same: we ensure a perfect match, then merge the data using `left_join` and finally create the map using `tmap`. While the simple linear regression was not so conclusive, it seems like the map enables one to grasp interesting patterns. If we look at the map we see that at least those areas with no CCTVs are more likely to be quite wealthy. However, we are not sure whether this is the only influential factor here, thus we think it is rather correlated to crime per capita in these areas. Again, in the northern parts we see less CCTV, less crime, and also more wealthier population.

```{r echo=FALSE, results = 'markup'}

baltimore$community %in% poverty_data$CSA2010 #We see that we have a perfect match

baltimore@data <- left_join(baltimore@data, poverty_data, by = c('community' = 'CSA2010'))

Wealth_and_CCTV_map <- tm_shape(baltimore)+tm_fill(col = "hhpov19", title ="Poverty rate per Area",style = "quantile") + tm_borders(col="black",alpha=0.3) + tm_layout(inner.margins = 0.05)+ tm_shape(balt_dat) + tm_dots(col="black") #This visualization is particularly interesting. Indeed, while the regression between crime rates and CCTV density was not very conclusive (we obtained a very poor R squared suggesting a poor correlation between poverty and CCTV density), this map might actually explain why we obtained such result and give us interesting hints. Indeed, we see that many CCTVs are located in Downtown/Seton Hill and in Inner Harbor/Federal Hill, namely in the centre of Baltimore and that the poverty rates is very low in these two regions. This makes sense as centers of city are typically not the poorest areas. Yet, what we also see is that many of the least poor region in the "suburbs" often have very low CCTV densities. This might confirm the idea that there tends to be less CCTVs in richer neighborhood.

tmap_mode("view")
Wealth_and_CCTV_map
```

### 4.5 Comparison of crimes and wealth

We want to investigate whether or not wealthier areas are more or less impacted by crime. To do so, we once more compute a simple linear regression. We again see that the $R^2$ is quite poor.

```{r echo=FALSE, results = 'markup'}

Crime_VS_Poverty <- CrimeStatsPerArea %>% 
  left_join(poverty_data,by=c("Community"="CSA2010"))

regression3 <- lm(Crime_VS_Poverty$CrimePer1000inhabitants~Crime_VS_Poverty$hhpov19)

stargazer(regression3,
          title = "CrimePer1000Inhabitants vs Poverty",
          type = "html")

ggplot(data=Crime_VS_Poverty,mapping= aes(x=hhpov19,y=CrimePer1000inhabitants)) + 
  labs(title = "Crime per Capita VS poverty rate", x="Poverty rate",y="Crime per Capita")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)
```

### 4.6 Felonies VS Misdemeanors - Do we have an equal crime type distribution?

It is always interesting to see whether we can spot patterns in crime date. The idea here is to analyse whether  we tend to observe an equal distribution of felony and misdemeanors in each area. By computing a simple linear regression, we see that the two types of crime seems rather equally distributed in each area. Still, it is interesting to observe that the biggest outline on the scatter plot is Downtown/Seton Hill. In Downtown, misdemeanor per capita is much larger than the felony per capita We don't whether this finding is relevant, yet, it must be mentioned that this area also is one of the richest area in Baltimore. This might **suggest** the idea that richer areas are more impacted by less severe crimes.

```{r echo=FALSE, results = 'markup'}

Felony_VS_Misdemeanor <- FelonyStats %>% 
  left_join(MisdemeanorStats,by="Community")

regression4 <- lm(Felony_VS_Misdemeanor$FelonyPerCapitaPerArea~Felony_VS_Misdemeanor$MisdemeanorPerCapitaPerArea)
#This allows us to see whether Felony and Misdemeanors are correlated. This seems to be the case

stargazer(regression4,
          title = "Felony vs Misdemeanor",
          type = "text")

ggplot(data=Felony_VS_Misdemeanor,mapping= aes(x=FelonyPerCapitaPerArea,y=MisdemeanorPerCapitaPerArea)) + 
  labs(title = "Misdemeanor VS Felony", x="Felons per capita",y="Misdemeanor per capita")+
  geom_point(shape=1) + 
  geom_smooth(method = lm,color="blue",size=0.3)

#Still, we see that there seems ot be some outliers. I don't know if it is relevant but the biggest outlier is Downtown/Seton Hill, is turns out it also is one of the richest area in Baltimore.
```

### 4.7 Attempt to create a more accurate model: Multiple Regression

```{r echo=FALSE, results = 'markup'}

#Socio-economic indicators:

Unemployment <- read.csv(file = here::here("data/Unemployment_Rate.csv"))

Unemployment[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0,0,0,0,0,0,0)

Internet_data <- read.csv(file = here::here("data/Percent_of_Households_with_No_Internet_at_Home.csv"))

Internet_data[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0)

#Educational indicators:

HSAexam <- read.csv(file = here::here("data/Percentage_of_Students_Passing_H.S.A._Government.csv"))

HSAexam[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0)

Readiness <- read.csv(file = here::here("data/Kindergarten_School_Readiness.csv"))

Readiness[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0)

#Racial indicators

Caucasian_perc <- read.csv(file = here::here("data/Percent_of_Residents_-_White_Caucasian_(Non-Hispanic).csv"))

Caucasian_perc[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0,0,0,0)

AfroAm_perc <- read.csv(file = here::here("data/Percent_of_Residents_-_Black_African-American_(Non-Hispanic).csv"))

AfroAm_perc[56,] <- list(56,"Unassigned -- Jail",0,0,0,0,0,0,0,0,0)

Community_data <- Community_data %>% 
  left_join(HSAexam[,c(2,6)],by=c("Community"="CSA2010")) %>%
  left_join(Internet_data[,c(2,5)],by=c("Community"="CSA2010")) %>% 
  left_join(Readiness[,c(2,5)],by=c("Community"="CSA2010")) %>% 
  left_join(Unemployment[,c(2,12)],by=c("Community"="CSA2010"))%>% 
  left_join(Caucasian_perc[,c(2,9)],by=c("Community"="CSA2010"))%>% 
  left_join(AfroAm_perc[,c(2,9)],by=c("Community"="CSA2010"))

fullmod <- lm(Community_data$density_perc~Community_data$ViolentCrimePerCapitaPerArea + Community_data$hhpov19 +Community_data$hsagov14 + Community_data$nohhint19+Community_data$ready13+Community_data$unempr19+Community_data$pwhite20+Community_data$paa20)

nullmod <- lm(Community_data$density_perc~1)

selAIC <- step(nullmod,scope=list(lower=nullmod,upper=fullmod),direction="forward")
#We have a satisfactory R-Squared

stargazer(selAIC,
          title = "Community data vs",
          type = "text")

library(car)
vif(selAIC) #Yet, the issue is that we have multicollinearity

lm(Community_data$paa20~Community_data$pwhite20)
summary(lm(Community_data$paa20~Community_data$pwhite20)) #This illustrates the mutlicollinearity issue, percentage of white people is highly correlated with percentage of black people

lm(Community_data$density_perc~Community_data$pwhite20+Community_data$paa20)
summary(lm(Community_data$density_perc~Community_data$pwhite20+Community_data$paa20)) #We observe that the percentage of white people is negatively correlated with CCTV density while the percentage of black people is positively correlated. However, none of the results are significant.

lm(Community_data$density_perc~Community_data$pwhite20)
summary(lm(Community_data$density_perc~Community_data$pwhite20))

lm(Community_data$density_perc~Community_data$paa20)
summary(lm(Community_data$density_perc~Community_data$paa20)) #Overall, this enables us to conclude that the race does not seem to be such a good predictor

fullmod2 <- lm(Community_data$density_perc~Community_data$ViolentCrimePerCapitaPerArea + Community_data$hhpov19 +Community_data$hsagov14 + Community_data$nohhint19 + Community_data$ready13 + Community_data$unempr19)

nullmod <- lm(Community_data$density_perc~1)

selAIC2 <- step(nullmod,scope=list(lower=nullmod,upper=fullmod2),direction="forward")
summary(selAIC2) #We see that internet access information and readiness are not even included and that among the included variables, only two are significant: violent crime and unemployment rate. This enables us to conclude that like racial metrics, educational metrics are poor predictors of CCTV levels.

library(car)
vif(selAIC2) #We can try to make a multiple regression containing the only two significant variables: 

CCTV_VS_ViolentCrime_and_Unemp <- lm(Community_data$density_perc~Community_data$ViolentCrimePerCapitaPerArea+Community_data$unempr19)

summary(CCTV_VS_ViolentCrime_and_Unemp) #We see that unemployment becomes insignificant

#Overall, it really seems that the main predictor of CCTV density that we could observe is violent crime. Racial metrics, educational metrics and socio economic indicators are quite poor predictors. We must note that linear regressions with 56 observations might also be problematic to yield great results.

#Yet, this statement must be mitigated. Indeed, with R-squared of approximatnely 50%, we are in situation where we can only explain 50% of the  variation. This means that thee approximantely is 50% of the variation whose origin is unknown to us. 

```

### 4.67 Next steps after feedback on project update

+ Adjust accroding to the feedback 
+ Create new models (potentially multiple linear regression ?)
+ Finalise interpetations and answer research questions
+ Compare results to other researches 
+ Create some more visualisations (if useful and needed)
+ Include Executive summary at the beginning
+ Add additional data if needed
+ Create bibliography
+ hello guys